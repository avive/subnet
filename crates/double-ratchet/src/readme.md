# Crate Double Ratchet
A modern Rust implementation of the double ratchet algorithm.




## About Ratchets

What is a Ratchet ?
1. A device consisting of a bar or wheel with a set of angled teeth in which a pawl, cog, or tooth engages, allowing motion in one direction only.
2. A situation or process that is changing steadily in a series of irreversible steps.

## Double Ratchets

### KDF Chains
- A KDF function is a deterministic one way function that receives 2 inputs and outputs 2 outputs. 
kdf(a, b) = {c, d}
- In a KDF chain - one output goes to a next KDF function as one of the inputs. 
- The other output is used to generate an encryption key.

## DH protocol init:
DH requires both parties to agree on a secret session key. This can be done by the X2DH protocol:
 
1. B: Generates (PubKB, PrivKB) ratchet key pair and shares PubB with A. (for example, in X2DH bundle).
This is called a pre-key.
2. A Generates (PubKA, PrivKA) - a ratchet key pair. (called an ephemeral key in X2DH protocol)
3. A computes new SessionKey := f(PrivKA, PubKB) and sends to B PubKA, IKA. (It can sign with IKA to auth)
4. B receives PubKA, IKA and computes the same SessionKey := f(PubKA, IKA, PrivKB).
5. Both parties use the SessionKey and PubKA as the initial 2 inputs to the root chain. 

First step:

- Each DH step is a 2 chain steps in the dh chain as 2 keys needs to be created for the 2 chains to advance - one for the send and one for the receive chain.

1. The outputs of the first step on root chain. Output 1 - Receive chain session key. Output 2 - input to next dr step...
2. 2nd step performed: input: Output 2 from prev step + same session key -> Output 1 - Send chain session key. Output 2: input to the next dr step...

- Next steps:
- When a party receives a new public key ratchet from another party it uses it to advance the chain and this is the only time it advances.
- So when a party generates a new key pair, it doesn't update the dh chain but keeps the pair, sends the other one the pub key, and updates it
only when it gets the other party public key, using its private key to generate a new session key...
- Each DH step is 2 steps in the dh chain as 2 keys needs to be created for the 2 chains to advance - one for the send and one for the receive chain.
- When a party sends a message ot the other party, it also sends the public key of a new pair it generates. It keeps sending 
this key until it receives from the other party a new public key...
- Upon receiving a public key, the party should generate a new key pair, create a new session key,
perform a DH chain step (which includes last dh output as input, and 2 actual steps) and send back the newly 
generated pub key with a message back to the sender so it can also perform a dh step on their end...


---------

1. A DH Ratchet
    - A DH chain produces a `SessionKey`.
    - `RatchetKeyPair` := `RatchetKeyPublic`, `RatchetKeySecret`.
    - `RatchetKeySecret` is generated by a party to move the DH ratchet to its next state. It sends.
    the matching `RatchetKeyPublic` to the other party so it can update its own DH ratchet.
    - When a `RatchetKeyPublic` is received by a party, it updates its root chain.
    this is called a `DH ratchet step`. The DH chain output `SessionKey` is the KDF input to the root chain.
    - Each outgoing messages contains a `RatchetKeyPublic` key which is part of a new DH key pair generated by the sender.

3. 2 symmetric ratchets:
    There are 3 chains per entities pair:
    - `a & b root chain` - Input: SessionKey. Output `ChainKey` is KDF input to the chains below and input to the next root kdf key.
    - `a -> b chain` (sending for a, receiving for b). Input: ChainKey. Output: `MessageKey`, `ChainKey`.
    - `b -> a chain` (sending for b, receiving for a). Input: ChainKey. Output: `MessageKey`, `ChainKey`.

- A's sending chain is B's receiving chain and vice versa.
- The output of the root chain `ChainKey` is used as input to the sending and receding chains.
- Each chain updates its private key based on the some of the outputs of the previous step.
- The output of the sending and receiving chains is a `MessageKey` - it is used to derive a symmetric enc key.
- The initial shared secret between A and B (output of X2DH protocol) is the initial root key and the initial DH KDF chain is built using:
IKA, pre-key public of B.


Combining the symmetric-key and DH ratchets gives the Double Ratchet:
- Received messages include `RatchetKeyPublic` (used for the DH ratchet).
- When a new `RatchetKeyPublic` is received, a DH ratchet step is performed prior to the symmetric-key ratchet,
  to replace the chain keys. (a HD step includes 2 iterations of the root chain to produce 2 new chain keys, one for send and one for receive chains)
- When a message is sent or received, a symmetric-key ratchet step is applied. 
 to the sending or receiving chains to derive the message key on both ends.
- Note that if Alice wants to send Bob 3 messages then she keeps advancing her sending chain key but keeps
the same root key. Only after receiving a new RatchetKeyPublic from Bob she can advance the root chain...
- Messages `include the index of the sending message key` so the receiver knows how many ratchet steps to perform on its receiving chain
to create the same message key as the sender.
 


    